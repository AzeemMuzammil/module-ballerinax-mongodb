version: '3.8'

services:
  mongo-no-auth:
    image: mongo:4.2
    restart: always
    ports:
      - 27016:27017

  mongo-no-ssl:
    image: mongo:4.2
    restart: always
    ports:
      - 27017:27017
    volumes:
      - ./init-scripts/no-ssl.js:/docker-entrypoint-initdb.d/init-mongo.js:ro
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongo localhost:27017/test --quiet
      interval: 30s
      timeout: 20s
      retries: 3
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: admin

  mongo-with-ssl:
    image: mongo:4.2
    restart: always
    ports:
      - 27018:27018
    volumes:
      - ./init-scripts/ssl.js:/docker-entrypoint-initdb.d/init-mongo.js:ro
      - ./certs/mongodb-server.pem:/etc/ssl/mongodb.pem:ro
      - ./certs/mongodb-CA.pem:/etc/ssl/mongodb-ca.pem:ro
    depends_on:
      mongo-no-ssl:
        condition: service_healthy
    command: --port 27018 --tlsMode requireTLS --tlsCertificateKeyFile /etc/ssl/mongodb.pem --tlsCAFile /etc/ssl/mongodb-ca.pem

#   mongo.one.db:
#     container_name: mongo.one.db
#     image: mongo:4.2
#     networks:
#       common.network:
#     ports:
#       - 20000:27017
#     volumes:
#       - ./init-scripts/no-ssl.js:/docker-entrypoint-initdb.d/init-mongo.js:ro
#       - mongo.one.vol:/data/db
#     restart: always
#     entrypoint: [ "/usr/bin/mongod", "--bind_ip_all", "--replSet", "dbrs" ]

#   mongo.two.db:
#     container_name: mongo.two.db
#     image: mongo:4.2
#     networks:
#       common.network:
#     ports:
#       - 20001:27017
#     depends_on:
#       - mongo.one.db
#     volumes:
#       - ./init-scripts/no-ssl.js:/docker-entrypoint-initdb.d/init-mongo.js:ro
#       - mongo.two.vol:/data/db
#     restart: always
#     entrypoint: [ "/usr/bin/mongod", "--bind_ip_all", "--replSet", "dbrs" ]

#   mongo.three.db:
#     container_name: mongo.three.db
#     image: mongo:4.2
#     networks:
#       common.network:
#     ports:
#       - 20002:27017
#     depends_on:
#       - mongo.one.db
#     volumes:
#       - ./init-scripts/no-ssl.js:/docker-entrypoint-initdb.d/init-mongo.js:ro
#       - mongo.three.vol:/data/db
#     restart: always
#     entrypoint: [ "/usr/bin/mongod", "--bind_ip_all", "--replSet", "dbrs" ]

# volumes:
#   mongo.one.vol:
#     name: "mongo.one.vol"

#   mongo.two.vol:
#     name: "mongo.two.vol"

#   mongo.three.vol:
#     name: "mongo.three.vol"

# networks:
#   common.network:
#     driver: bridge
